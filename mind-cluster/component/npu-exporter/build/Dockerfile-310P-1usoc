FROM ubuntu:22.04

RUN groupadd -g 1000 HwHiAiUser && useradd -u 1000 -g HwHiAiUser -d /home/HwHiAiUser -m HwHiAiUser &&\
    groupadd -g 1101 HwDmUser && useradd -u 1101 -g HwDmUser -d /home/HwDmUser -m HwDmUser &&\
    groupadd -g 1102 HwBaseUser && useradd -u 1102 -g HwBaseUser -d /home/HwBaseUser -m HwBaseUser &&\
    usermod -a -G HwBaseUser HwHiAiUser &&\
    usermod -a -G HwDmUser HwHiAiUser &&\
    usermod -a -G HwBaseUser HwDmUser &&\
    usermod -a -G HwHiAiUser HwDmUser &&\
    usermod root -s /usr/sbin/nologin

COPY ./npu-exporter  /usr/local/bin/
COPY ./run_for_310P_1usoc.sh /
COPY ./metricConfiguration.json  /usr/local/metricConfiguration.json
COPY ./pluginConfiguration.json /usr/local/pluginConfiguration.json

RUN chown root:root /usr/local/bin/npu-exporter  &&\
    chmod 500 /run_for_310P_1usoc.sh &&\
    chmod 550 /usr/local/bin/ &&\
    chmod 500 /usr/local/bin/npu-exporter &&\
    chmod 440 /usr/local/metricConfiguration.json &&\
    chmod 440 /usr/local/pluginConfiguration.json &&\
    echo 'umask 027' >> /etc/profile && \
    echo 'source /etc/profile' >> ~/.bashrc

RUN ln -s /lib /lib64 2>&1 >> /dev/null &&\
    mkdir -m 750 /var/driver -m 750 /var/dmp -m 750 /usr/slog -p -m 750 /home/drv/hdc_ppc &&\
    chown HwDmUser:HwDmUser /var/dmp &&\
    chown HwHiAiUser:HwHiAiUser /var/driver &&\
    chown HwHiAiUser:HwHiAiUser /home/drv/hdc_ppc &&\
    chown HwHiAiUser:HwHiAiUser /usr/slog